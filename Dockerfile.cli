
FROM python:3.6

MAINTAINER Alex Myasoedov <msoedov@gmail.com>

WORKDIR /app

RUN pip install fire requests retry yaspin

ENV PY_LIB "aW1wb3J0IGxvZ2dpbmcKaW1wb3J0IHRpbWUKZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgZGVmYXVsdGRpY3QsIG5hbWVkdHVwbGUKZnJvbSBjb25jdXJyZW50LmZ1dHVyZXMgaW1wb3J0IFRocmVhZFBvb2xFeGVjdXRvciwgVGltZW91dEVycm9yCgppbXBvcnQgZmlyZQppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IHlhc3Bpbgpmcm9tIHJldHJ5IGltcG9ydCByZXRyeQoKbG9nID0gbG9nZ2luZy5nZXRMb2dnZXIoKQoKd2l0aF9yZXRyeV9wb2xpY3kgPSByZXRyeSgKICAgICgKICAgICAgICByZXF1ZXN0cy5Db25uZWN0aW9uRXJyb3IsCiAgICAgICAgcmVxdWVzdHMuSFRUUEVycm9yLAogICAgICAgIHJlcXVlc3RzLkNvbm5lY3RUaW1lb3V0LAogICAgICAgIHJlcXVlc3RzLlJlYWRUaW1lb3V0LAogICAgICAgIHJlcXVlc3RzLlJlcXVlc3RFeGNlcHRpb24sCiAgICApLAogICAgZGVsYXk9MSwKICAgIHRyaWVzPTUsCiAgICBiYWNrb2ZmPTIsCikKCgpjbGFzcyBBcHBTdGF0dXMobmFtZWR0dXBsZSgiU3RhdHVzIiwgInZlcnNpb24sIHRvdGFsX2NudCwgc3VjY2Vzc19jbnQiKSk6CiAgICBwYXNzCgoKY2xhc3MgQWdyZWdhdGVkU3RhdHVzKG5hbWVkdHVwbGUoIlN0YXR1cyIsICJ2ZXJzaW9uLCB0b3RhbF9jbnQsIHN1Y2Nlc3NfY250IikpOgoKICAgIEBwcm9wZXJ0eQogICAgZGVmIHJhdGUoc2VsZikgLT4gZmxvYXQ6CiAgICAgICAgcmV0dXJuIHNlbGYuc3VjY2Vzc19jbnQgLyBzZWxmLnRvdGFsX2NudCBpZiB0b3RhbF9jbnQgPiAwIGVsc2UgMS4wCgogICAgZGVmIGFkZChzZWxmLCBzdGF0dXMpOgogICAgICAgIHNlbGYudmVyc2lvbiA9IHN0YXR1cy52ZXJzaW9uCiAgICAgICAgc2VsZi50b3RhbF9jbnQgKz0gc3RhdHVzLnRvdGFsX2NudAogICAgICAgIHNlbGYuc3VjY2Vzc19jbnQgKz0gc3RhdHVzLnN1Y2Nlc3NfY250CgoKQHdpdGhfcmV0cnlfcG9saWN5CmRlZiBjaGVja19lbmRwb2ludCgKICAgIGhvc3RfcHJlZml4OiBzdHIsIGhvc3RfZ3JvdXA9InR3aXR0ZXIuY29tIgopIC0+IChBcHBTdGF0dXMgb3IgTm9uZSwgRXhjZXB0aW9uIG9yIE5vbmUpOgoKICAgIHIgPSByZXF1ZXN0cy5nZXQoZiJodHRwOi8ve2hvc3RfcHJlZml4fS57aG9zdF9ncm91cH0vc3RhdHVzIikKICAgIGlmIG5vdCByLm9rOgogICAgICAgIHJldHVybiBOb25lLCBSdW50aW1lRXJyb3IoCiAgICAgICAgICAgIGYiQ291bGQgbm90IGdldCB7aG9zdF9wcmVmaXh9Lntob3N0X2dyb3VwfSAgZGV0YWlscz17ci5jb250ZW50WzoyMDBdfSIKICAgICAgICApCgogICAgIyBTY2hlbWEKICAgICMgW3siQXBwbGljYXRpb24iOiJDYWNoZTIiLCJWZXJzaW9uIjoiMS4wLjEiLCJVcHRpbWUiOjQ2Mzc3MTk0MTcsCiAgICAjICJSZXF1ZXN0X0NvdW50Ijo1MTk0ODAwMDI5LCJFcnJvcl9Db3VudCI6MTA0MjgxMzI1MSwiU3VjY2Vzc19Db3VudCI6NDE1MTk4Njc3OH0sCiAgICB0cnk6CiAgICAgICAgcCA9IHIuanNvbigpCiAgICAgICAgcmV0dXJuIEFwcFN0YXR1cygKICAgICAgICAgICAgdmVyc2lvbj1wLmdldCgiVmVyc2lvbiIsICJVbmtub3duIiksCiAgICAgICAgICAgIHRvdGFsX2NudD1wLmdldCgiUmVxdWVzdF9Db3VudCIsIDApLAogICAgICAgICAgICBzdWNjZXNzX2NudD1wLmdldCgiU3VjY2Vzc19Db3VudCIsIDApLAogICAgICAgICksIE5vbmUKCiAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICByZXR1cm4gTm9uZSwgUnVudGltZUVycm9yKAogICAgICAgICAgICBmIkNvdWxkIG5vdCBnZXQge2hvc3RfcHJlZml4fS57aG9zdF9ncm91cH0gYmFkIHBheWxvYWQge3IuY29udGVudFs6MjAwXX0iCiAgICAgICAgKQoKCmRlZiBfcnVuKHNlcnZlcnNfZmlsZSwgd29ya2Vycywgc3RhZ2UpOgogICAgc3RhZ2Uud3JpdGUoIj4gUmVhZGluZyBmaWxlIikKCiAgICB3aXRoIG9wZW4oc2VydmVyc19maWxlLCAiciIpIGFzIGZwOgogICAgICAgIGRhdGEgPSBmcC5yZWFkKCkKICAgIHNlcnZlcnMgPSBbZGF0dW0uc3RyaXAoIlx0ICIpIGZvciBkYXR1bSBpbiBkYXRhLnNwbGl0KCJcbiIpIGlmIGRhdHVtXQogICAgcG9vbCA9IFRocmVhZFBvb2xFeGVjdXRvcihtYXhfd29ya2Vycz13b3JrZXJzKQogICAgc3RhZ2Uud3JpdGUoIj4gQnJld2luZyBjb2ZmZWUiKQogICAgcmVzdWx0cyA9IFtdCiAgICBmb3Igc2VydmVyIGluIHNlcnZlcnM6CiAgICAgICAgbG9nLmRlYnVnKCJTcGF3bmluZyBmb3IgJXMiLCBzZXJ2ZXIpCiAgICAgICAgZnV0ID0gcG9vbC5zdWJtaXQoY2hlY2tfZW5kcG9pbnQsIChzZXJ2ZXIsKSkKICAgICAgICByZXN1bHRzLmFwcGVuZChmdXQpCiAgICBzdGFnZS53cml0ZSgiPiBDcmVhdGluZyAgYSB0aHJlYWQgcG9vbCIpCgogICAgZ3JvdXBfYnlfdmVyc2lvbjoge3N0cjogQWdyZWdhdGVkU3RhdHVzfSA9IGRlZmF1bHRkaWN0KAogICAgICAgIGxhbWJkYSBzOiBBZ3JlZ2F0ZWRTdGF0dXMoIiIsIDAsIDApCiAgICApCiAgICBzdGFnZS53cml0ZSgiPiBQcm9jZXNzaW5nIikKICAgIGZvciByIGluIHJlc3VsdHM6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdGF0dXMsIGVyciA9IHIucmVzdWx0KHRpbWVvdXQ9NjApCiAgICAgICAgZXhjZXB0IFRpbWVvdXRFcnJvcjoKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgbG9nLmV4Y2VwdGlvbigiU2tpcHBpbmciKQogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBpZiBlcnI6CiAgICAgICAgICAgIGxvZy5lcnJvcigiJXMiLCBlcnIpCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGdyb3VwX2J5X3ZlcnNpb25bc3RhdHVzLnZlcnNpb25dLmFkZChzdGF0dXMpCgogICAgcHJpbnQoIlZlcnNpb24gfCBTdWNjZXNzIHJhdGUiKQogICAgZm9yIHZlcnNpb24sIGFnZyBpbiBncm91cF9ieV92ZXJzaW9uLml0ZW1zKCk6CiAgICAgICAgcHJpbnQoZiJ7dmVyc2lvbn0gfCB7YWdnLnJhdGUoKX0iKQogICAgc3RhZ2Uub2soIuKclCIpCgoKZGVmIHJ1bihzZXJ2ZXJzX2ZpbGU6IHN0ciwgd29ya2VyczogaW50ID0gNSk6CiAgICAiIiJEaWFnbm9zdGljIGNsaSBhcHAKCiAgICBBcmd1bWVudHM6CiAgICAgICAgc2VydmVyc19maWxlIHtzdHJ9IC0tIGEgcGxhaW4gdGV4dCBmaWxlIHdpdGggbGlzdCBvZiBzZXJ2ZXJzCgogICAgS2V5d29yZCBBcmd1bWVudHM6CiAgICAgICAgd29ya2VycyB7aW50fSAtLSBudW1iZXIgb2YgdGhyZWFkcyAoZGVmYXVsdDogezV9KQogICAgIiIiCgogICAgd2l0aCB5YXNwaW4ueWFzcGluKHRleHQ9IkNoZWNraW5nIHN0YXR1cyIsIGNvbG9yPSJjeWFuIikgYXMgc3RhZ2U6CiAgICAgICAgX3J1bihzZXJ2ZXJzX2ZpbGU9c2VydmVyc19maWxlLCB3b3JrZXJzPXdvcmtlcnMsIHN0YWdlPXN0YWdlKQogICAgcmV0dXJuCgoKZGVmIGVudHJ5cG9pbnQoKToKICAgIGZpcmUuRmlyZShydW4pCgoKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIGVudHJ5cG9pbnQoKQo="
RUN python -c "import os,base64;b=os.getenv('PY_LIB');b=base64.b64decode(b);print(b.decode('utf-8'))" | tee app.py

CMD python app.py
