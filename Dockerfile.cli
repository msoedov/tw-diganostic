
FROM python:3.6

MAINTAINER Alex Myasoedov <msoedov@gmail.com>

WORKDIR /app

RUN pip install fire requests retry yaspin

ENV PY_LIB "aW1wb3J0IGxvZ2dpbmcKaW1wb3J0IHRpbWUKZnJvbSBjb2xsZWN0aW9ucyBpbXBvcnQgZGVmYXVsdGRpY3QsIG5hbWVkdHVwbGUKZnJvbSBjb25jdXJyZW50LmZ1dHVyZXMgaW1wb3J0IEZ1dHVyZSwgVGhyZWFkUG9vbEV4ZWN1dG9yLCBUaW1lb3V0RXJyb3IKCmltcG9ydCBmaXJlCmltcG9ydCByZXF1ZXN0cwppbXBvcnQgeWFzcGluCmZyb20gcmV0cnkgaW1wb3J0IHJldHJ5Cgpsb2cgPSBsb2dnaW5nLmdldExvZ2dlcigpCgp3aXRoX3JldHJ5X3BvbGljeSA9IHJldHJ5KAogICAgKAogICAgICAgIHJlcXVlc3RzLkNvbm5lY3Rpb25FcnJvciwKICAgICAgICByZXF1ZXN0cy5IVFRQRXJyb3IsCiAgICAgICAgcmVxdWVzdHMuQ29ubmVjdFRpbWVvdXQsCiAgICAgICAgcmVxdWVzdHMuUmVhZFRpbWVvdXQsCiAgICAgICAgcmVxdWVzdHMuUmVxdWVzdEV4Y2VwdGlvbiwKICAgICksCiAgICBkZWxheT0xLAogICAgdHJpZXM9NSwKICAgIGJhY2tvZmY9MiwKKQoKCmNsYXNzIEFwcFN0YXR1cyhuYW1lZHR1cGxlKCJTdGF0dXMiLCAibmFtZSwgdmVyc2lvbiwgdG90YWxfY250LCBzdWNjZXNzX2NudCIpKToKICAgIHBhc3MKCgpjbGFzcyBBZ3JlZ2F0ZWRTdGF0dXM6CgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHNlbGYudG90YWxfY250OiBmbG9hdCA9IDAKICAgICAgICBzZWxmLnN1Y2Nlc3NfY250OiBmbG9hdCA9IDAKCiAgICBAcHJvcGVydHkKICAgIGRlZiByYXRlKHNlbGYpIC0+IGZsb2F0OgogICAgICAgICIiIgogICAgICAgIENhbGN1bGF0ZSBhIHN1Y2Nlc3MgcmF0ZS4gUmV0dXJuIDEgaWYgbm8gcmVxdWVzdHMgd2VyZSByZWNvcmRlZAogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLnN1Y2Nlc3NfY250IC8gc2VsZi50b3RhbF9jbnQgaWYgc2VsZi50b3RhbF9jbnQgPiAwIGVsc2UgMS4wCgogICAgZGVmIGFkZChzZWxmLCBzdGF0dXM6IEFwcFN0YXR1cyk6CiAgICAgICAgc2VsZi50b3RhbF9jbnQgKz0gc3RhdHVzLnRvdGFsX2NudAogICAgICAgIHNlbGYuc3VjY2Vzc19jbnQgKz0gc3RhdHVzLnN1Y2Nlc3NfY250CgoKQHdpdGhfcmV0cnlfcG9saWN5CmRlZiBjaGVja19lbmRwb2ludCgKICAgIGhvc3RfcHJlZml4OiBzdHIsIGhvc3RfZ3JvdXA9InR3aXR0ZXIuY29tIgopIC0+IChBcHBTdGF0dXMgb3IgTm9uZSwgRXhjZXB0aW9uIG9yIE5vbmUpOgoKICAgIHIgPSByZXF1ZXN0cy5nZXQoZiJodHRwOi8ve2hvc3RfcHJlZml4fS57aG9zdF9ncm91cH0vc3RhdHVzIikKICAgIGlmIG5vdCByLm9rOgogICAgICAgIHJldHVybiBOb25lLCBSdW50aW1lRXJyb3IoCiAgICAgICAgICAgIGYiQ291bGQgbm90IGdldCB7aG9zdF9wcmVmaXh9Lntob3N0X2dyb3VwfSAgZGV0YWlscz17ci5jb250ZW50WzoyMDBdfSIKICAgICAgICApCgogICAgIyBSZXNwb25zZSBzY2hlbWEKICAgICMgeyJBcHBsaWNhdGlvbiI6IkNhY2hlMiIsIlZlcnNpb24iOiIxLjAuMSIsIlVwdGltZSI6NDYzNzcxOTQxNywKICAgICMgIlJlcXVlc3RfQ291bnQiOjUxOTQ4MDAwMjksIkVycm9yX0NvdW50IjoxMDQyODEzMjUxLCJTdWNjZXNzX0NvdW50Ijo0MTUxOTg2Nzc4fQogICAgdHJ5OgogICAgICAgIHAgPSByLmpzb24oKQogICAgICAgIHJldHVybiBBcHBTdGF0dXMoCiAgICAgICAgICAgIHZlcnNpb249cC5nZXQoIlZlcnNpb24iLCAiVW5rbm93biIpLAogICAgICAgICAgICB0b3RhbF9jbnQ9cC5nZXQoIlJlcXVlc3RfQ291bnQiLCAwKSwKICAgICAgICAgICAgc3VjY2Vzc19jbnQ9cC5nZXQoIlN1Y2Nlc3NfQ291bnQiLCAwKSwKICAgICAgICAgICAgbmFtZT1wLmdldCgiQXBwbGljYXRpb24iKSwKICAgICAgICApLCBOb25lCgogICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgcmV0dXJuIE5vbmUsIFJ1bnRpbWVFcnJvcigKICAgICAgICAgICAgZiJDb3VsZCBub3QgZ2V0IHtob3N0X3ByZWZpeH0ue2hvc3RfZ3JvdXB9IGJhZCBwYXlsb2FkIHtyLmNvbnRlbnRbOjIwMF19IgogICAgICAgICkKCgpkZWYgX3J1bihzZXJ2ZXJzLCB3b3JrZXJzLCBzdGFnZSk6CiAgICBwb29sID0gVGhyZWFkUG9vbEV4ZWN1dG9yKG1heF93b3JrZXJzPXdvcmtlcnMpCiAgICBzdGFnZS53cml0ZSgiPiBCcmV3aW5nIGNvZmZlZSIpCiAgICByZXN1bHRzID0gW10KICAgIGZvciBzZXJ2ZXIgaW4gc2VydmVyczoKICAgICAgICBsb2cuZGVidWcoIlNwYXduaW5nIGZvciAlcyIsIHNlcnZlcikKICAgICAgICBmdXQgPSBwb29sLnN1Ym1pdChjaGVja19lbmRwb2ludCwgc2VydmVyKQogICAgICAgIHJlc3VsdHMuYXBwZW5kKGZ1dCkKICAgIHN0YWdlLndyaXRlKCI+IENyZWF0aW5nICBhIHRocmVhZCBwb29sIikKCiAgICBncm91cHBlZF9ieV9uYW1lX2FuZF92ZXJzaW9uOiB7c3RyOiBBZ3JlZ2F0ZWRTdGF0dXN9ID0gZGVmYXVsdGRpY3QoCiAgICAgICAgbGFtYmRhOiBBZ3JlZ2F0ZWRTdGF0dXMoKQogICAgKQogICAgc3RhZ2Uud3JpdGUoIj4gUHJvY2Vzc2luZyIpCiAgICBmb3IgZnV0IGluIHJlc3VsdHM6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdGF0dXMsIGVyciA9IGZ1dC5yZXN1bHQodGltZW91dD02MCkKICAgICAgICBleGNlcHQgVGltZW91dEVycm9yOgogICAgICAgICAgICBjb250aW51ZQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBsb2cuZXhjZXB0aW9uKCJTa2lwcGluZyIpCiAgICAgICAgICAgIGNvbnRpbnVlCgogICAgICAgIGlmIGVycjoKICAgICAgICAgICAgbG9nLmVycm9yKCIlcyIsIGVycikKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgZ3JvdXBwZWRfYnlfbmFtZV9hbmRfdmVyc2lvbltmIntzdGF0dXMubmFtZX06e3N0YXR1cy52ZXJzaW9ufSJdLmFkZChzdGF0dXMpCgogICAgc3RhZ2Uub2soIuKclCIpCiAgICBwcmludCgiVmVyc2lvbiB8IFN1Y2Nlc3MgcmF0ZSIpCgogICAgZm9yIHZlcnNpb24sIGFnZyBpbiBncm91cHBlZF9ieV9uYW1lX2FuZF92ZXJzaW9uLml0ZW1zKCk6CiAgICAgICAgcHJpbnQoZiJ7dmVyc2lvbn0gfCB7YWdnLnJhdGV9IikKICAgIHJldHVybiBncm91cHBlZF9ieV9uYW1lX2FuZF92ZXJzaW9uCgoKZGVmIHJ1bihzZXJ2ZXJzX2ZpbGU6IHN0ciwgd29ya2VyczogaW50ID0gNSk6CiAgICAiIiJEaWFnbm9zdGljIGNsaSBhcHAKCiAgICBBcmd1bWVudHM6CiAgICAgICAgc2VydmVyc19maWxlIHtzdHJ9IC0tIGEgcGxhaW4gdGV4dCBmaWxlIHdpdGggbGlzdCBvZiBzZXJ2ZXJzCgogICAgS2V5d29yZCBBcmd1bWVudHM6CiAgICAgICAgd29ya2VycyB7aW50fSAtLSBudW1iZXIgb2YgdGhyZWFkcyAoZGVmYXVsdDogezV9KQogICAgIiIiCgogICAgd2l0aCB5YXNwaW4ueWFzcGluKHRleHQ9IkNoZWNraW5nIHN0YXR1cyIsIGNvbG9yPSJjeWFuIikgYXMgc3RhZ2U6CiAgICAgICAgc3RhZ2Uud3JpdGUoIj4gUmVhZGluZyBmaWxlIikKICAgICAgICB3aXRoIG9wZW4oc2VydmVyc19maWxlLCAiciIpIGFzIGZwOgogICAgICAgICAgICBkYXRhID0gZnAucmVhZCgpCiAgICAgICAgc2VydmVycyA9IFtkYXR1bS5zdHJpcCgiXHQgIikgZm9yIGRhdHVtIGluIGRhdGEuc3BsaXQoIlxuIikgaWYgZGF0dW1dCiAgICAgICAgX3J1bihzZXJ2ZXJzPXNlcnZlcnMsIHdvcmtlcnM9d29ya2Vycywgc3RhZ2U9c3RhZ2UpCiAgICByZXR1cm4KCgpkZWYgZW50cnlwb2ludCgpOgogICAgZmlyZS5GaXJlKHJ1bikKCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgZW50cnlwb2ludCgpCg=="
RUN python -c "import os,base64;b=os.getenv('PY_LIB');b=base64.b64decode(b);print(b.decode('utf-8'))" | tee app.py

CMD python app.py
